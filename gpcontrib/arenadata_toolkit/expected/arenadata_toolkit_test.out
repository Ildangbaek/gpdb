----------------------------------------------------------------------------------------------------------
-- test helpers
----------------------------------------------------------------------------------------------------------
-- start_matchsubs
-- m/oid_\d+/
-- s/oid_\d+/oid_oid/
-- m/pg_ao(seg|visimap)_\d+/
-- s/pg_ao(seg|visimap)_\d+/pg_ao$1_oid/
-- end_matchsubs
-- function that mocks manual installation of arenadata_toolkit from bundle
CREATE FUNCTION mock_manual_installation() RETURNS VOID AS $$
BEGIN
	CREATE SCHEMA arenadata_toolkit;
	EXECUTE 'GRANT ALL ON SCHEMA arenadata_toolkit to ' || (SELECT current_user);
	CREATE TABLE arenadata_toolkit.db_files_history (field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY
		PARTITION BY RANGE(field) (START (1) END(3) EVERY(2), DEFAULT PARTITION extra);
	CREATE TABLE arenadata_toolkit.daily_operation(field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY;
	CREATE TABLE arenadata_toolkit.operation_exclude(schema_name TEXT) WITH (appendonly=true) DISTRIBUTED RANDOMLY;
END;
$$ LANGUAGE plpgsql;
-- function that returns information about tables that belongs to the arenadata_toolkit schema (and schema itself)
CREATE or replace FUNCTION get_toolkit_objects_info() RETURNS TABLE (objid oid, textoid text, objtype TEXT, objname NAME, objstorage "char", objacl TEXT) AS $$
DECLARE
	r RECORD;
	tables name[];
BEGIN
	FOR r IN 
		SELECT oid, relname, relstorage from pg_class where relnamespace = (select oid from pg_namespace where nspname = 'arenadata_toolkit') order by relname
	LOOP
		SELECT array_append(tables, r.relname) into tables;
		-- AO tables creates additional pg_aoseg and pg_aovisimap tables with suffix _<oid> where oid - oid of AO table
		IF r.relstorage = 'a'::"char" THEN
			SELECT array_append(tables, ('pg_aoseg_' || r.oid)::name) into tables;
			SELECT array_append(tables, ('pg_aovisimap_' || r.oid)::name) into tables;
		END IF;
	END LOOP;
	RETURN QUERY SELECT * FROM
		(SELECT oid, 'oid_' || oid, 'schema', nspname, '-'::"char",
			replace(nspacl::text, (select current_user), 'owner') AS acl -- replace current_user to static string, to prevent test flakiness
			FROM pg_namespace WHERE nspname = 'arenadata_toolkit') a UNION
		(SELECT oid, 'oid_' || oid, 'table', relname, relstorage,
			replace(relacl::text, (select current_user), 'owner') AS acl -- replace current_user to static string, to prevent test flakiness
			FROM pg_class WHERE relname IN (select unnest(tables))
		);
END;
$$ LANGUAGE plpgsql;
----------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------
-- test case 1 (create extension from unpackaged): arenadata_toolkit installed manually, tables
-- db_files, db_files_current and db_files_history_backup_N weren't created by toolkit
----------------------------------------------------------------------------------------------------------
-- setup
SELECT mock_manual_installation();
NOTICE:  CREATE TABLE will create partition "db_files_history_1_prt_extra" for table "db_files_history"
CONTEXT:  SQL statement "CREATE TABLE arenadata_toolkit.db_files_history (field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY
		PARTITION BY RANGE(field) (START (1) END(3) EVERY(2), DEFAULT PARTITION extra)"
PL/pgSQL function mock_manual_installation() line 5 at SQL statement
NOTICE:  CREATE TABLE will create partition "db_files_history_1_prt_2" for table "db_files_history"
CONTEXT:  SQL statement "CREATE TABLE arenadata_toolkit.db_files_history (field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY
		PARTITION BY RANGE(field) (START (1) END(3) EVERY(2), DEFAULT PARTITION extra)"
PL/pgSQL function mock_manual_installation() line 5 at SQL statement
 mock_manual_installation 
--------------------------
 
(1 row)

-- check that created toolkit objects don't depend on extension
SELECT * FROM pg_depend d JOIN (SELECT * FROM get_toolkit_objects_info()) objs ON d.objid = objs.objid AND d.deptype='e';
 classid | objid | objsubid | refclassid | refobjid | refobjsubid | deptype | objid | textoid | objtype | objname | objstorage | objacl 
---------+-------+----------+------------+----------+-------------+---------+-------+---------+---------+---------+------------+--------
(0 rows)

-- show toolkit objects (and their grants) that belongs to arenadata_toolkit schema
SELECT textoid, objname, objtype, objstorage, objacl FROM (SELECT * FROM get_toolkit_objects_info()) t ORDER BY objname;
  textoid  |           objname            | objtype | objstorage |      objacl      
-----------+------------------------------+---------+------------+------------------
 oid_26305 | arenadata_toolkit            | schema  | -          | {owner=UC/owner}
 oid_26331 | daily_operation              | table   | a          | 
 oid_26306 | db_files_history             | table   | a          | 
 oid_26322 | db_files_history_1_prt_2     | table   | a          | 
 oid_26313 | db_files_history_1_prt_extra | table   | a          | 
 oid_26338 | operation_exclude            | table   | a          | 
 oid_26308 | pg_aoseg_26306               | table   | h          | 
 oid_26315 | pg_aoseg_26313               | table   | h          | 
 oid_26325 | pg_aoseg_26322               | table   | h          | 
 oid_26333 | pg_aoseg_26331               | table   | h          | 
 oid_26343 | pg_aoseg_26338               | table   | h          | 
 oid_26310 | pg_aovisimap_26306           | table   | h          | 
 oid_26317 | pg_aovisimap_26313           | table   | h          | 
 oid_26327 | pg_aovisimap_26322           | table   | h          | 
 oid_26335 | pg_aovisimap_26331           | table   | h          | 
 oid_26345 | pg_aovisimap_26338           | table   | h          | 
(16 rows)

-- run the unpackaged script
CREATE extension arenadata_toolkit FROM unpackaged;
-- show toolkit objects (and their grants) that belongs to arenadata_toolkit schema after creating extension
SELECT textoid, objname, objtype, objstorage, objacl FROM (SELECT * FROM get_toolkit_objects_info()) t ORDER BY objname;
  textoid  |           objname            | objtype | objstorage |             objacl             
-----------+------------------------------+---------+------------+--------------------------------
 oid_26305 | arenadata_toolkit            | schema  | -          | {owner=UC/owner,=U/owner}
 oid_26331 | daily_operation              | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26349 | db_files_current             | table   | h          | {owner=arwdDxt/owner,=r/owner}
 oid_26306 | db_files_history             | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26322 | db_files_history_1_prt_2     | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26313 | db_files_history_1_prt_extra | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26338 | operation_exclude            | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26308 | pg_aoseg_26306               | table   | h          | 
 oid_26315 | pg_aoseg_26313               | table   | h          | 
 oid_26325 | pg_aoseg_26322               | table   | h          | 
 oid_26333 | pg_aoseg_26331               | table   | h          | 
 oid_26343 | pg_aoseg_26338               | table   | h          | 
 oid_26310 | pg_aovisimap_26306           | table   | h          | 
 oid_26317 | pg_aovisimap_26313           | table   | h          | 
 oid_26327 | pg_aovisimap_26322           | table   | h          | 
 oid_26335 | pg_aovisimap_26331           | table   | h          | 
 oid_26345 | pg_aovisimap_26338           | table   | h          | 
(17 rows)

-- check that toolkit objects now depends on extension
SELECT textoid, objname, objtype, extname, deptype FROM pg_depend d JOIN
	(SELECT * FROM get_toolkit_objects_info()) objs ON d.objid = objs.objid JOIN
	pg_extension e ON d.refobjid = e.oid
WHERE d.deptype = 'e' AND e.extname = 'arenadata_toolkit' ORDER BY objname;
  textoid  |      objname      | objtype |      extname      | deptype 
-----------+-------------------+---------+-------------------+---------
 oid_26305 | arenadata_toolkit | schema  | arenadata_toolkit | e
 oid_26331 | daily_operation   | table   | arenadata_toolkit | e
 oid_26349 | db_files_current  | table   | arenadata_toolkit | e
 oid_26306 | db_files_history  | table   | arenadata_toolkit | e
 oid_26338 | operation_exclude | table   | arenadata_toolkit | e
(5 rows)

-- check all objects were deleted
DROP extension arenadata_toolkit;
SELECT * FROM (SELECT * FROM get_toolkit_objects_info()) t;
 objid | textoid | objtype | objname | objstorage | objacl 
-------+---------+---------+---------+------------+--------
(0 rows)

----------------------------------------------------------------------------------------------------------
-- test case 2 (create extension from unpackaged): arenadata_toolkit installed manually, tables
-- db_files, db_files_current and db_files_history_backup_N were created by toolkit
----------------------------------------------------------------------------------------------------------
-- setup
SELECT mock_manual_installation();
NOTICE:  CREATE TABLE will create partition "db_files_history_1_prt_extra" for table "db_files_history"
CONTEXT:  SQL statement "CREATE TABLE arenadata_toolkit.db_files_history (field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY
		PARTITION BY RANGE(field) (START (1) END(3) EVERY(2), DEFAULT PARTITION extra)"
PL/pgSQL function mock_manual_installation() line 5 at SQL statement
NOTICE:  CREATE TABLE will create partition "db_files_history_1_prt_2" for table "db_files_history"
CONTEXT:  SQL statement "CREATE TABLE arenadata_toolkit.db_files_history (field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY
		PARTITION BY RANGE(field) (START (1) END(3) EVERY(2), DEFAULT PARTITION extra)"
PL/pgSQL function mock_manual_installation() line 5 at SQL statement
 mock_manual_installation 
--------------------------
 
(1 row)

CREATE TABLE arenadata_toolkit.db_files_current (field TEXT) DISTRIBUTED RANDOMLY;
CREATE TABLE arenadata_toolkit.db_files_history_backup_N (field INT) WITH (appendonly=true) DISTRIBUTED RANDOMLY
	PARTITION BY RANGE(field) (START (1) END(3) EVERY(2), DEFAULT PARTITION extra);
NOTICE:  CREATE TABLE will create partition "db_files_history_backup_n_1_prt_extra" for table "db_files_history_backup_n"
NOTICE:  CREATE TABLE will create partition "db_files_history_backup_n_1_prt_2" for table "db_files_history_backup_n"
CREATE EXTERNAL WEB TABLE arenadata_toolkit.db_files (field TEXT) EXECUTE 'echo 1' FORMAT 'TEXT';
-- check that created objects don't depend on extension
SELECT * FROM pg_depend d JOIN (SELECT * FROM get_toolkit_objects_info()) objs ON d.objid = objs.objid AND d.deptype='e';
 classid | objid | objsubid | refclassid | refobjid | refobjsubid | deptype | objid | textoid | objtype | objname | objstorage | objacl 
---------+-------+----------+------------+----------+-------------+---------+-------+---------+---------+---------+------------+--------
(0 rows)

-- show toolkit objects (and their grants) that belongs to arenadata_toolkit schema
SELECT textoid, objname, objtype, objstorage, objacl FROM (SELECT * FROM get_toolkit_objects_info()) t ORDER BY objname;
  textoid  |                objname                | objtype | objstorage |      objacl      
-----------+---------------------------------------+---------+------------+------------------
 oid_26355 | arenadata_toolkit                     | schema  | -          | {owner=UC/owner}
 oid_26381 | daily_operation                       | table   | a          | 
 oid_26429 | db_files                              | table   | x          | 
 oid_26398 | db_files_current                      | table   | h          | 
 oid_26356 | db_files_history                      | table   | a          | 
 oid_26372 | db_files_history_1_prt_2              | table   | a          | 
 oid_26363 | db_files_history_1_prt_extra          | table   | a          | 
 oid_26404 | db_files_history_backup_n             | table   | a          | 
 oid_26420 | db_files_history_backup_n_1_prt_2     | table   | a          | 
 oid_26411 | db_files_history_backup_n_1_prt_extra | table   | a          | 
 oid_26388 | operation_exclude                     | table   | a          | 
 oid_26358 | pg_aoseg_26356                        | table   | h          | 
 oid_26365 | pg_aoseg_26363                        | table   | h          | 
 oid_26375 | pg_aoseg_26372                        | table   | h          | 
 oid_26383 | pg_aoseg_26381                        | table   | h          | 
 oid_26393 | pg_aoseg_26388                        | table   | h          | 
 oid_26406 | pg_aoseg_26404                        | table   | h          | 
 oid_26413 | pg_aoseg_26411                        | table   | h          | 
 oid_26423 | pg_aoseg_26420                        | table   | h          | 
 oid_26360 | pg_aovisimap_26356                    | table   | h          | 
 oid_26367 | pg_aovisimap_26363                    | table   | h          | 
 oid_26377 | pg_aovisimap_26372                    | table   | h          | 
 oid_26385 | pg_aovisimap_26381                    | table   | h          | 
 oid_26395 | pg_aovisimap_26388                    | table   | h          | 
 oid_26408 | pg_aovisimap_26404                    | table   | h          | 
 oid_26415 | pg_aovisimap_26411                    | table   | h          | 
 oid_26425 | pg_aovisimap_26420                    | table   | h          | 
(27 rows)

-- run the unpackaged script
CREATE extension arenadata_toolkit FROM unpackaged;
-- show toolkit objects (and their grants) that belongs to arenadata_toolkit schema after creating extension
SELECT textoid, objname, objtype, objstorage, objacl FROM (SELECT * FROM get_toolkit_objects_info()) t ORDER BY objname;
  textoid  |                objname                | objtype | objstorage |             objacl             
-----------+---------------------------------------+---------+------------+--------------------------------
 oid_26355 | arenadata_toolkit                     | schema  | -          | {owner=UC/owner,=U/owner}
 oid_26381 | daily_operation                       | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26398 | db_files_current                      | table   | h          | {owner=arwdDxt/owner,=r/owner}
 oid_26356 | db_files_history                      | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26372 | db_files_history_1_prt_2              | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26363 | db_files_history_1_prt_extra          | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26404 | db_files_history_backup_n             | table   | a          | 
 oid_26420 | db_files_history_backup_n_1_prt_2     | table   | a          | 
 oid_26411 | db_files_history_backup_n_1_prt_extra | table   | a          | 
 oid_26388 | operation_exclude                     | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26358 | pg_aoseg_26356                        | table   | h          | 
 oid_26365 | pg_aoseg_26363                        | table   | h          | 
 oid_26375 | pg_aoseg_26372                        | table   | h          | 
 oid_26383 | pg_aoseg_26381                        | table   | h          | 
 oid_26393 | pg_aoseg_26388                        | table   | h          | 
 oid_26406 | pg_aoseg_26404                        | table   | h          | 
 oid_26413 | pg_aoseg_26411                        | table   | h          | 
 oid_26423 | pg_aoseg_26420                        | table   | h          | 
 oid_26360 | pg_aovisimap_26356                    | table   | h          | 
 oid_26367 | pg_aovisimap_26363                    | table   | h          | 
 oid_26377 | pg_aovisimap_26372                    | table   | h          | 
 oid_26385 | pg_aovisimap_26381                    | table   | h          | 
 oid_26395 | pg_aovisimap_26388                    | table   | h          | 
 oid_26408 | pg_aovisimap_26404                    | table   | h          | 
 oid_26415 | pg_aovisimap_26411                    | table   | h          | 
 oid_26425 | pg_aovisimap_26420                    | table   | h          | 
(26 rows)

-- check that toolkit objects now depends on extension
SELECT textoid, objname, objtype, extname, deptype FROM pg_depend d JOIN
	(SELECT * FROM get_toolkit_objects_info()) objs ON d.objid = objs.objid JOIN
	pg_extension e ON d.refobjid = e.oid
WHERE d.deptype = 'e' AND e.extname = 'arenadata_toolkit' ORDER BY objname;
  textoid  |      objname      | objtype |      extname      | deptype 
-----------+-------------------+---------+-------------------+---------
 oid_26355 | arenadata_toolkit | schema  | arenadata_toolkit | e
 oid_26381 | daily_operation   | table   | arenadata_toolkit | e
 oid_26398 | db_files_current  | table   | arenadata_toolkit | e
 oid_26356 | db_files_history  | table   | arenadata_toolkit | e
 oid_26388 | operation_exclude | table   | arenadata_toolkit | e
(5 rows)

-- must fail, because db_files_history_backup_N should be dropped manually
DROP extension arenadata_toolkit;
ERROR:  cannot drop extension arenadata_toolkit because other objects depend on it
DETAIL:  append only table arenadata_toolkit.db_files_history_backup_n depends on schema arenadata_toolkit
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
DROP TABLE arenadata_toolkit.db_files_history_backup_N;
-- check all objects were deleted
DROP extension arenadata_toolkit;
SELECT * FROM (SELECT * FROM get_toolkit_objects_info()) t;
 objid | textoid | objtype | objname | objstorage | objacl 
-------+---------+---------+---------+------------+--------
(0 rows)

----------------------------------------------------------------------------------------------------------
-- test case 3 (create extension): there is no arenadata_toolkit - new installation
----------------------------------------------------------------------------------------------------------
create extension arenadata_toolkit;
-- show toolkit objects (and their grants) that belongs to arenadata_toolkit schema after creating extension
SELECT textoid, objname, objtype, objstorage, objacl FROM (SELECT * FROM get_toolkit_objects_info()) t ORDER BY objname;
  textoid  |      objname       | objtype | objstorage |             objacl             
-----------+--------------------+---------+------------+--------------------------------
 oid_26434 | arenadata_toolkit  | schema  | -          | {owner=UC/owner,=U/owner}
 oid_26441 | daily_operation    | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26435 | db_files_current   | table   | h          | {owner=arwdDxt/owner,=r/owner}
 oid_26451 | operation_exclude  | table   | a          | {owner=arwdDxt/owner,=r/owner}
 oid_26446 | pg_aoseg_26441     | table   | h          | 
 oid_26456 | pg_aoseg_26451     | table   | h          | 
 oid_26448 | pg_aovisimap_26441 | table   | h          | 
 oid_26458 | pg_aovisimap_26451 | table   | h          | 
(8 rows)

-- check that toolkit objects were created by extension and check their grants
SELECT textoid, objname, objtype, extname, deptype FROM pg_depend d JOIN
	(SELECT * FROM get_toolkit_objects_info()) objs ON d.objid = objs.objid JOIN
	pg_extension e ON d.refobjid = e.oid
WHERE d.deptype = 'e' AND e.extname = 'arenadata_toolkit' ORDER BY objname;
  textoid  |      objname       | objtype |      extname      | deptype 
-----------+--------------------+---------+-------------------+---------
 oid_26434 | arenadata_toolkit  | schema  | arenadata_toolkit | e
 oid_26441 | daily_operation    | table   | arenadata_toolkit | e
 oid_26435 | db_files_current   | table   | arenadata_toolkit | e
 oid_26451 | operation_exclude  | table   | arenadata_toolkit | e
 oid_26446 | pg_aoseg_26441     | table   | arenadata_toolkit | e
 oid_26456 | pg_aoseg_26451     | table   | arenadata_toolkit | e
 oid_26448 | pg_aovisimap_26441 | table   | arenadata_toolkit | e
 oid_26458 | pg_aovisimap_26451 | table   | arenadata_toolkit | e
(8 rows)

-- check all objects were deleted
DROP extension arenadata_toolkit;
SELECT * FROM (SELECT * FROM get_toolkit_objects_info()) t;
 objid | textoid | objtype | objname | objstorage | objacl 
-------+---------+---------+---------+------------+--------
(0 rows)

